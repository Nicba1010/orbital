version: 0.0.{build}-{branch}

branches:
  except:
    - gh-pages

environment:
  APPVEYOR_YML_DISABLE_PS_LINUX: true

image:
- Visual Studio 2017

install:
- sh: |
    sudo apt-get update
    sudo apt-get -yqq install python wget
    sudo apt-get -yqq install dh-autoreconf bison flex
    sudo apt-get -yqq install zlib1g-dev libglib2.0-dev libfdt-dev libpixman-1-dev libsdl2-dev libvulkan-dev libusb-1.0-0-dev
    wget http://archive.ubuntu.com/ubuntu/pool/universe/libz/libzip/libzip5_1.5.1-0ubuntu1_amd64.deb
    wget http://archive.ubuntu.com/ubuntu/pool/universe/libz/libzip/libzip-dev_1.5.1-0ubuntu1_amd64.deb
    sudo dpkg -i libzip5_1.5.1-0ubuntu1_amd64.deb
    sudo dpkg -i libzip-dev_1.5.1-0ubuntu1_amd64.deb
    rm libzip5_1.5.1-0ubuntu1_amd64.deb
    rm libzip-dev_1.5.1-0ubuntu1_amd64.deb
- ps: |
    set MSYSTEM=MINGW64
    C:\msys64\usr\bin\pacman --noconfirm -Syyu
    C:\msys64\usr\bin\pacman --needed --noconfirm -S git python2
    C:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-toolchain base-devel
    C:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-glib2 mingw-w64-x86_64-gtk3
    C:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-vulkan mingw-w64-x86_64-SDL2
    C:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-glslang mingw-w64-x86_64-libzip
    C:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-libusb openssl-devel
before_build:
- ps: |
    set MSYSTEM=MINGW64
    C:\msys64\usr\bin\bash -lc 'if [ -f /usr/bin/python ]; then mv /usr/bin/python /usr/bin/python.bak; fi; ln -s /usr/bin/python2 /usr/bin/python'
    C:\msys64\usr\bin\bash -lc 'mv /mingw64/bin/envsubst.exe /mingw64/bin/envsubst.exe.bak; ln -s /usr/bin/envsubst.exe /mingw64/bin/envsubst.exe'
    C:\msys64\usr\bin\bash -lc 'echo ''export PATH=/mingw64/bin:$PATH'' >> ~/.bash_profile'
    C:\msys64\usr\bin\bash -lc 'echo ''CPPFLAGS=-I/mingw64/include'' >> ~/.bash_profile'
    C:\msys64\usr\bin\bash -lc 'echo ''LDFLAGS=-L/mingw64/lib'' >> ~/.bash_profile'
- git submodule update --init --recursive

build_script:
- sh: ./build.sh
- ps: |
    set MSYSTEM=MINGW64
    C:\msys64\usr\bin\bash -lc 'ls /mingw64/include'
    C:\msys64\usr\bin\bash -lc 'cc -m64 -dM -E -x c /dev/null | grep "WIN"'
    C:\msys64\usr\bin\bash -lc "cd /c/projects/orbital; ./build.sh"